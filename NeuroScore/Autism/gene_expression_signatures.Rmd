---
title: "Neurodevelopmental gene expression signatures"
author: "Urwah Nawaz"
date: "15 January 2020"
output:
  html_document:
    toc: true
    theme: lumen
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
```

# Paper summary
The study by Velmeshev et al (2019) analysed transcriptomic changes in the brains of individuals with autism to gain insight into the molecular pathology of ASD in a cell-type specifc manner.

The study used single-nucleus RNA-sequencing strategy on postmortem tissue samples including the prefrontal cortex and anerior cingulator cortex from 15 ASD patients and 16 controls. None of the ASD patients were diagnosed with ID. Additionally, patients that only had sporadic epilespy were also included in this analysis along with 7 age matched controls.

## Characteristics of the data 

* Generated 104,559 single-nuclei gene expression profiles 

   * 52,556 from control subjects 
   * 52,003 from ASD patients 

* Detected a median of 1391 genes and 2213 transcripts per nucleus
* Identified 17 cell types by using expression of known cell markers
* Neurons expressed more genes and transcripts than glia 

* highlight key results from this study
    * what is single nucleus data 
    * why is it better to study instead of snRNA-seq for some scenarios 


## Differential expression results 

The study aimed to identify differentially expressed genes in cell-type specific manner by comparing nuclear profiles from ASD and controls using a linear mixed model. 

* Detected 692 differential expression events (q value < 0.05; expression level change > 10%) in 513 unique DEGs
* 76% of these were differentisally expressed in a single cell type
* Top differentially expressed genes in non-neuronal cell types were up-regulated in protoplasmic astrocytes and microglia 
* 75 DEGs were found in the SFARI database
* SFARI genes were most overrepresented in L2/3 and L4 excitatory neurons, followed by VIP and somatostatin expression interneurons 

Gene expression was also investigated in neuronal and glial subtypes. Over all this analysis revealed dysregulated development and synaptic signaling in components of upper-layer cortical circuitry as well as changes in the cellular state of microglia and protoplasmic astrocytes 




# Aim of analysis

To use a single-nucleus data from ASD cases and controls and calculate a "neurodevelopmental gene dysregulation score" for each ASD case and each control. 

Each of the genes may only show a minor change and different genes may be changed in different patients, however when we look at them as a group, we might see a cumulative effect. 


# Method Aims 

* Download data from Vekmeshev et al and create a expression matrix 

* Make a list of neurodevelopmental disease genes with subcategories

* Load data into R and perform an exploratory analysis 

* For each NDD gene 
    + Calculate the z-score of its expression in a given individual and cell type relative to all cells from controls in the same cell-type 
    + Box-plot these z-scores 
    + Calculate a wilcoxon test comparing NDD genes and non-NDD genes for each individual  


# Analysis 

## Gene lists

For this analysis, we want to investigate the expression of  NDD genes in ASD individuals compared to controls. 

Neurodevelopmental disorder gene lists: 

```{r gene list setup, echo=FALSE, eval=TRUE}
suppressPackageStartupMessages({
  library(pander)
  library(kableExtra)
  library(tibble)
  library(magrittr)
  library(dplyr)
  library(rmarkdown)
  library(gdata)
  library(biomaRt)
  library(EnsDb.Hsapiens.v79)
})
```

* ASD related genes 

List of genes was downloaded from SFARI database and includes 913 genes in total

```{r echo=FALSE, eval=TRUE}
ASD_genes <- read.csv("~/Documents/PhD_year1/Lists/SFARI-Gene_genes_01-03-2020release_02-02-2020export.csv")


ASD_genes %>%
  dplyr::select("gene.symbol", "gene.name", "ensembl.id", 
                "chromosome", "gene.score", "number.of.reports") %>%
  kable(escape = F, align = "c") %>%
  kable_styling(c("striped", "condensed"), full_width = F) %>%
  kable_styling(bootstrap_options = "striped", full_width = F) %>%
  scroll_box(width = "1000px", height = "200px")
  

```



* Intellectual disability genes


```{r ID genes, echo =FALSE, eval=TRUE}
ID_genes <- read.xls("~/Documents/PhD_year1/Lists/ID_Speech_delay_genes.xls") %>% 
  as.data.frame() %>%
  column_to_rownames("Gene")
geneSymbols <- as.character(rownames(ID_genes))
geneIDs <- ensembldb::select(EnsDb.Hsapiens.v79, keys= geneSymbols, keytype = "SYMBOL", columns = c("SYMBOL","GENEID"))
ID_genes_complete <- merge(as.data.frame(ID_genes), 
                           as.data.frame(geneIDs), by.x = "row.names",
                           by.y = "SYMBOL", sort=FALSE)

ID_genes_complete %>% 
  dplyr::select("Gene" = "Row.names", "GENEID","Phenotype") %>%
  kable(escape = F, align = "c") %>%
  kable_styling(c("striped", "condensed"), full_width = F) %>%
  kable_styling(bootstrap_options = "striped", full_width = F) %>%
  scroll_box(width = "1000px", height = "200px")

```

   * Epilpsy genes 
   
```{r}
Epi_genes <- read.xls("~/Documents/PhD_year1/Lists/Final_Epil_list_annotated_Jan19.xls")  %>% 
  as.data.frame() 

geneSymbols <- as.character(Epi_genes$old.list)
geneIDs <- ensembldb::select(EnsDb.Hsapiens.v79, keys= geneSymbols, keytype = "SYMBOL", columns = c("SYMBOL","GENEID"))

Epi_genes_complete <- merge(as.data.frame(Epi_genes), 
                           as.data.frame(geneIDs), by.x = "old.list",
                           by.y = "SYMBOL", sort=FALSE)


Epi_genes_complete %>% 
  as.data.frame() %>%
  dplyr::select("Gene" = "old.list", "GENEID", "Type") %>%
  kable(escape = F, align = "c") %>%
 kable_styling(c("striped", "condensed"), full_width = F) %>% kable_styling(bootstrap_options = "striped", full_width = F) %>%
  scroll_box(width = "1000px", height = "200px")
  
```

## Exploratory analysis 

 In this section, we explore several properties of the sn-RNAseq data including mean expression and variation of expression of various genes. Raw data from UCSC cell browser was downloaded and loaded into R. A SingleCellExperiment object was created and the data was filtered and normalized.

```{r loading data}
sce <- readRDS("singleCell_QC.rds")
```


### Detection of gene expression

```{r detection}
plotColData(sce, x="sum", y="detected", colour_by = "cluster")
```

 * Genes detected 
 * mean expression of genes (in all transformations?)
 * expression of NDD vs non-NDD genes in clusters 
 * which cluster expresses the most amount of NDD genes 
 * variance of expression 



## Gene expression signature analysis 

Checklist 

* write function for z-score calculation 
   * Must subset 1 ASD individual, all controls in 1 cell type  per gene 
   * must group (average) expression of cells per individual 
   * transpose and calculate z-score 
   * End must be matrix with z-score for each cluster for each gene 


* Plot boxplot for top 10 interesting genes (per gene list)

```{r}
## get names of all individuals that are ASD 
#autism <- meta %>%
#  rownames_to_column("sample_name") %>%
#  dplyr::filter(diagnosis == "ASD") %>% 
#  column_to_rownames("sample_name")

#autism_ind <- unique(autism$individual)
#autism_ind
```

```{r}
#ASD_4849_oligo <- meta %>% 
 # rownames_to_column("sample_name") %>% 
  #dplyr::filter((individual == 4849 | diagnosis == "Control") & cluster == #"Oligodendrocytes") %>% 
  #column_to_rownames("sample_name")


#sample_names <- rownames(ASD_4849_oligo)
#head(sample_names)
```

```{r}
#ASD_4849_oligo_mat <- dplyr::select(mat, sample_names)

#head(ASD_4849_oligo_mat)[1:30]
```


# Side notes 

## Single-nucleus RNA-seq 

Single-nucleus RNA-seq strategies involve analyzing the nuclei instead of cells. This method is advantegeous when attempting to profile expression in cells that are difficult to isolate such as frozen tissue samples. 

More reading here: 


## Normalization in sc-RNAseq 

Various normalization methods exist for bulk RNA-seq which can be applied to sc-RNAseq, however sources of variation specific to sc-RNAseq such as technical dropouts make it necessary to have normalization methods specific to sc-RNAseq 

* Most commonly used normalization method includes CPM normalization 

* CPM normalization assumes that all cells in the dataset initially contain an equal number of mRNA molecules and count depth differences arise only due to sampling. 

* After normalization, data matrices are typically log(x+1) transformation. This transformation has three main effects:

   * Distances between log-transformed expression values represent log fold changes 
   * Log transformations mitigates mean variance relationship in sc data
   * Log transformation reduces the skewness of the data to approximate the assumption of a data that is normally distributed
